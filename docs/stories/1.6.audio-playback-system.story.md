# Story 1.6: Audio Playback System

## Status
Draft

## Story

**As a** user,  
**I want** to play Italian audio content through a clean, minimal interface that seamlessly handles content transitions when scrolling,  
**so that** I can focus on listening without interface distractions and smoothly move between different episodes.

## Acceptance Criteria

1. HTML5 Audio API integrated with custom playback controls
2. Play, pause, skip forward (15 seconds), and skip backward (15 seconds) controls implemented
3. Audio controls are visible and accessible but unobtrusive (minimal visual footprint)
4. Playback position indicator displays current time and total duration
5. Audio playback works seamlessly across all supported browsers and devices
6. Audio continues playing when user switches browser tabs or minimizes window (mobile)
7. Playback controls respond to user interactions within 100ms
8. Audio buffering and loading states handled gracefully (loading indicator, error handling)
9. Audio playback quality is clear and consistent across devices
10. System handles content switching triggered by scrolling (stops current playback, loads new content, starts playback)
11. Audio player can load and play multiple different content sources (supports content from generation and from temporary storage)
12. Smooth audio transitions when switching between content (fade out/in or clean stop/start without audio glitches)
13. Playback state properly managed when scrolling (pause current, play new, maintain position for previously played content)

## Tasks / Subtasks

- [ ] Task 1: Enhance AudioPlayer Component with Full Functionality (AC: 1, 2, 3, 4, 7, 8, 9)
  - [ ] Review existing AudioPlayer component in `apps/lovable_web/src/components/AudioPlayer.tsx`
  - [ ] Verify HTML5 Audio API integration is complete
  - [ ] Ensure play, pause, skip forward (15s), and skip backward (15s) controls are fully functional
  - [ ] Verify playback position indicator shows current time and total duration
  - [ ] Ensure controls are minimal and unobtrusive (verify styling matches design requirements)
  - [ ] Implement loading states and error handling for audio buffering
  - [ ] Test playback quality and consistency across devices
  - [ ] Verify controls respond within 100ms to user interactions

- [ ] Task 2: Implement Background Playback Support (AC: 6)
  - [ ] Ensure audio continues playing when browser tab is switched or window minimized
  - [ ] Test background playback on mobile devices (iOS Safari, Chrome Mobile)
  - [ ] Test background playback on desktop browsers (Chrome, Firefox, Safari, Edge)
  - [ ] Handle browser auto-play policies appropriately
  - [ ] Verify audio playback state persists across tab switches

- [ ] Task 3: Integrate Audio Player with Scroll-Triggered Content Switching (AC: 10, 11, 12, 13)
  - [ ] Integrate AudioPlayer with MainListeningScreen scroll detection
  - [ ] Implement content switching logic: stop current playback when scrolling
  - [ ] Implement new content loading: load audio URL from Content object (audioUrl field)
  - [ ] Implement playback state management: pause current, play new content
  - [ ] Implement position tracking: maintain playback position for previously played content
  - [ ] Implement smooth audio transitions (fade out/in or clean stop/start)
  - [ ] Support multiple content sources (generated content and temporary storage)
  - [ ] Test content switching with scroll forward (new content generation)
  - [ ] Test content switching with scroll backward (session history)
  - [ ] Verify no audio glitches during content transitions

- [ ] Task 4: Create AudioPlayerContext for State Management (AC: 10, 11, 12, 13)
  - [ ] Create AudioPlayerContext in `apps/lovable_web/src/contexts/AudioPlayerContext.tsx`
  - [ ] Implement audio playback state management (current content, playback position, playing state)
  - [ ] Implement methods for content switching, play/pause control, skip controls
  - [ ] Integrate with ContentContext for content data access
  - [ ] Integrate with SessionContext for session-based content organization
  - [ ] Provide context provider to App component
  - [ ] Update AudioPlayer component to use AudioPlayerContext

- [ ] Task 5: Implement Behavioral Event Tracking for Audio Playback (AC: 1, 2, 3, 4, 10, 11, 12, 13)
  - [ ] Track play, pause, skip-forward, skip-backward events
  - [ ] Track playback position updates (for behavioral tracking)
  - [ ] Track content switching events (scroll-triggered content changes)
  - [ ] Track audio completion events
  - [ ] Integrate with event tracking service (prepare for API integration in future stories)
  - [ ] Store events locally for batch upload (prepare for API integration)

- [ ] Task 6: Cross-Browser and Cross-Device Testing (AC: 5, 6, 9)
  - [ ] Test audio playback on iOS Safari
  - [ ] Test audio playback on Chrome Mobile
  - [ ] Test audio playback on desktop Chrome
  - [ ] Test audio playback on desktop Firefox
  - [ ] Test audio playback on desktop Safari
  - [ ] Test audio playback on desktop Edge
  - [ ] Verify audio quality is consistent across all browsers and devices
  - [ ] Verify background playback works on all platforms
  - [ ] Document any browser-specific considerations or limitations

## Dev Notes

### Previous Story Insights

**From Story 1.5 (Responsive Web Application Framework):**
- MainListeningScreen component already has bidirectional scroll detection implemented (wheel events for desktop, touch events for mobile)
- Scroll detection infrastructure is in place with debouncing and threshold system
- Scroll-triggered content actions are placeholders for Epic 2 content generation
- AudioPlayer component already exists in `apps/lovable_web/src/components/AudioPlayer.tsx` with basic play/pause and skip controls
- React 18.3.1 with TypeScript 5.9.3 is configured
- Tailwind CSS 3.4.19 is configured for styling
- Vite 5.4.21 is configured for bundling
- Application structure supports PWA capabilities (manifest configured)

### Component Specifications

**AudioPlayer Component:**
- Location: `apps/lovable_web/src/components/AudioPlayer.tsx` [Source: docs/architecture/unified-project-structure.md]
- Purpose: HTML5 audio wrapper with custom controls (play, pause, skip forward/backward 15s) [Source: docs/architecture/components.md]
- Current State: Basic implementation exists with play/pause, skip controls, and progress indicator
- Required Enhancements: Background playback support, content switching integration, smooth transitions, behavioral event tracking

**AudioPlayerContext:**
- Location: `apps/lovable_web/src/contexts/AudioPlayerContext.tsx` [Source: docs/architecture/unified-project-structure.md]
- Purpose: React Context API for audio playback state management [Source: docs/architecture/components.md]
- Required: Create new context for managing audio playback state, content switching, and playback position tracking
- Integration: Must integrate with ContentContext and SessionContext

**MainListeningScreen Component:**
- Location: `apps/lovable_web/src/components/MainListeningScreen.tsx`
- Current State: Has scroll detection infrastructure, needs audio player integration
- Required: Integrate AudioPlayer component and handle scroll-triggered content switching

### Data Models

**Content Interface:**
- `audioUrl`: string - URL to audio file (S3/CDN) [Source: docs/architecture/data-models.md]
- `audioFormat`: 'mp3' | 'ogg' | 'wav' - Audio file format [Source: docs/architecture/data-models.md]
- `audioBitrate`: number - Audio bitrate in kbps [Source: docs/architecture/data-models.md]
- `duration`: number - Audio duration in seconds [Source: docs/architecture/data-models.md]
- `id`: string - Unique content identifier [Source: docs/architecture/data-models.md]
- `title`: string - Content title/name [Source: docs/architecture/data-models.md]
- `format`: 'narrative' | 'podcast' | 'educational' - Content format type [Source: docs/architecture/data-models.md]

**BehavioralEvent Interface:**
- Event types for audio playback: 'play', 'pause', 'resume', 'stop', 'skip-forward', 'skip-backward', 'complete', 'abandon' [Source: docs/architecture/data-models.md]
- Required fields: `contentId`, `eventType`, `timestamp`, `playbackPosition`, `sessionId`, `contentCharacteristics` [Source: docs/architecture/data-models.md]
- `playbackPosition`: number - Playback position in seconds at event time [Source: docs/architecture/data-models.md]
- `playbackPositionPercent`: number - Playback position as percentage (0-100) [Source: docs/architecture/data-models.md]

**Session Interface:**
- `id`: string - Unique session identifier [Source: docs/architecture/data-models.md]
- `currentContentId`: string | null - Currently playing content [Source: docs/architecture/data-models.md]
- `contentIds`: string[] - Ordered list of content IDs in session [Source: docs/architecture/data-models.md]

### API Specifications

**Content Retrieval:**
- GET `/api/content/{contentId}` - Retrieve generated content with audio URL [Source: docs/architecture/api-specification.md]
- Response includes Content object with `audioUrl` field [Source: docs/architecture/api-specification.md]

**Behavioral Event Tracking:**
- POST `/api/events` - Track single behavioral event [Source: docs/architecture/api-specification.md]
- POST `/api/events/batch` - Track multiple behavioral events (for efficiency) [Source: docs/architecture/api-specification.md]
- Note: API integration for event tracking will be implemented in future stories, but event data structure should be prepared

**Session Management:**
- GET `/api/sessions/{sessionId}` - Get session by ID [Source: docs/architecture/api-specification.md]
- PATCH `/api/sessions/{sessionId}` - Update session (e.g., currentContentId) [Source: docs/architecture/api-specification.md]

### File Locations

**Component Files:**
- AudioPlayer: `apps/lovable_web/src/components/AudioPlayer.tsx` [Source: docs/architecture/unified-project-structure.md]
- MainListeningScreen: `apps/lovable_web/src/components/MainListeningScreen.tsx` [Source: docs/architecture/unified-project-structure.md]

**Context Files:**
- AudioPlayerContext: `apps/lovable_web/src/contexts/AudioPlayerContext.tsx` [Source: docs/architecture/unified-project-structure.md]
- ContentContext: `apps/lovable_web/src/contexts/ContentContext.tsx` (may need to be created or verified) [Source: docs/architecture/unified-project-structure.md]
- SessionContext: `apps/lovable_web/src/contexts/SessionContext.tsx` (may need to be created or verified) [Source: docs/architecture/unified-project-structure.md]

**Service Files:**
- API Client: `apps/lovable_web/src/services/apiClient.ts` [Source: docs/architecture/unified-project-structure.md]
- Content Service: `apps/lovable_web/src/services/contentService.ts` [Source: docs/architecture/unified-project-structure.md]
- Event Service: `apps/lovable_web/src/services/eventService.ts` [Source: docs/architecture/unified-project-structure.md]

**Hook Files:**
- useAudioPlayer: `apps/lovable_web/src/hooks/useAudioPlayer.ts` [Source: docs/architecture/unified-project-structure.md]

### Technical Constraints

- **Frontend Framework:** Must use React 18.x [Source: docs/architecture/tech-stack.md]
- **TypeScript Version:** Must use TypeScript 5.x [Source: docs/architecture/tech-stack.md]
- **CSS Framework:** Must use Tailwind CSS 3.x [Source: docs/architecture/tech-stack.md]
- **State Management:** Must use React Context API (no external state management libraries) [Source: docs/architecture/tech-stack.md]
- **Audio API:** HTML5 Audio API for playback control [Source: docs/architecture/components.md]
- **Package Manager:** Must use pnpm (required for monorepo consistency) [Source: docs/architecture/tech-stack.md]

### Audio Format Requirements

- **Audio Format:** MP3 (128kbps recommended) [Source: docs/architecture/tech-stack.md]
- **Audio Storage:** AWS S3 with CDN (CloudFlare) for delivery [Source: docs/architecture/components.md]
- **Audio URL:** Content object includes `audioUrl` field pointing to CDN URL [Source: docs/architecture/data-models.md]

### Core Workflows

**Content Switching Workflow:**
- User scrolls forward/backward → MainListeningScreen detects scroll → Stop current playback → Load new content (from generation or session storage) → Start new playback → Update session state [Source: docs/architecture/core-workflows.md]

**Background Playback:**
- Audio must continue playing when browser tab is switched or window minimized [Source: Story AC 6]
- Browser auto-play policies must be handled appropriately

**Smooth Transitions:**
- When switching content, current playback should stop cleanly (or fade out) and new content should start (or fade in) without audio glitches [Source: Story AC 12]
- Options: Fade out/in or clean stop/start

### Project Structure Notes

- Components should be in `apps/lovable_web/src/components/` [Source: docs/architecture/unified-project-structure.md]
- Contexts should be in `apps/lovable_web/src/contexts/` [Source: docs/architecture/unified-project-structure.md]
- Services should be in `apps/lovable_web/src/services/` [Source: docs/architecture/unified-project-structure.md]
- Hooks should be in `apps/lovable_web/src/hooks/` [Source: docs/architecture/unified-project-structure.md]
- All file paths align with unified project structure [Source: docs/architecture/unified-project-structure.md]

### Testing

**Testing Standards:**
- Testing frameworks: Vitest + React Testing Library (for future automated tests) [Source: docs/architecture/tech-stack.md]
- Test file locations: `apps/lovable_web/tests/` or `apps/lovable_web/src/__tests__/` [Source: docs/architecture/unified-project-structure.md]
- This story focuses on manual testing and cross-browser/device verification
- Automated component tests can be added in future stories

**Testing Approach:**
- Manual cross-browser testing (iOS Safari, Chrome Mobile, desktop Chrome, Firefox, Safari, Edge)
- Manual cross-device testing (mobile, tablet, desktop)
- Performance testing (playback responsiveness, transition smoothness)
- Background playback testing (tab switching, window minimization)
- Content switching testing (scroll forward/backward, smooth transitions)

**Note:** This story does not require writing automated tests, only manual verification and cross-browser/device testing. Automated component tests will be added in future stories.

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-07 | 1.0 | Initial story draft created | Scrum Master |

## Dev Agent Record

### Agent Model Used
_To be populated by Dev Agent_

### Debug Log References
_To be populated by Dev Agent_

### Completion Notes List
_To be populated by Dev Agent_

### File List
_To be populated by Dev Agent_

## QA Results
_To be populated by QA Agent_
