# Story 2.1: Foundation Model Service Implementation

## Status
Validated

## Story

**As a** system,  
**I want** to implement the foundation language acquisition model as a centralized service,  
**so that** all content generation and adaptation decisions can be driven by model principles consistently.

## Acceptance Criteria

1. Model service created as centralized service module implementing foundation language acquisition model principles
2. Model service provides API for content generation parameters (determines generation parameters based on model principles)
3. Model service provides API for adaptation decisions (model-informed difficulty and content selection)
4. Model service provides API for signal interpretation (model framework for understanding behavioral signals)
5. Model service provides API for learner state representation (model-based learner state tracking)
6. Model service interface is versioned to support model evolution and refinement
7. Model service implements core model principles (meaning-first approach, comprehensibility before correctness, variation is essential, prediction under uncertainty, meaning anchoring, statistical abstraction, re-expression/compression)
8. Model service determines content generation parameters (lexical sets, construction sets, novelty budgets, variation patterns) according to model specifications
9. Model service provides prompt engineering guidance aligned with model principles (meaning-first prompts, controlled variation specifications)
10. Model service is computationally efficient (implements model principles through algorithms/heuristics, not full ML implementation)
11. Model service integrates with content generation pipeline (model parameters passed to generation service)
12. Model service designed for extensibility (ready for model refinement and increased sophistication in Phase 2+)

## Tasks / Subtasks

- [x] Task 1: Create Model Service Package Structure (AC: 1, 6)
  - [x] Create model service package in `packages/model-service/` following unified project structure [Source: docs/architecture/unified-project-structure.md]
  - [x] Set up TypeScript configuration for model service package
  - [x] Create package.json with dependencies (TypeScript 5.x, no external ML libraries for MVP) [Source: docs/architecture/tech-stack.md]
  - [x] Create versioned interface structure for model service API (v1 initial version) [Source: Story AC 6]
  - [x] Create base directory structure: `src/model/`, `src/interfaces/`, `src/utils/` [Source: docs/architecture/unified-project-structure.md]
  - [x] Set up test directory structure: `tests/` [Source: docs/architecture/unified-project-structure.md]

- [x] Task 2: Implement Model Service Interfaces and Types (AC: 1, 2, 3, 4, 5)
  - [x] Define ModelService interface with versioned API methods [Source: Story AC 6]
  - [x] Create GenerationParameters interface (lexicalNoveltyBudget, constructionSets, variationPattern, comprehensibilityTarget, semanticStability) [Source: docs/architecture/data-models.md]
  - [x] Create AdaptationRecommendations interface (recommendedFormats, recommendedGenres, difficultyAdjustment, templateRecommendations) [Source: docs/architecture/api-specification.md]
  - [x] Create SignalInterpretation interface (comprehensionLevel, preferenceWeights, contentTypePreferences) [Source: docs/architecture/data-models.md]
  - [x] Create LearnerState interface (preferenceWeights, comprehensionLevel, contentTypePreferences, difficultyAdjustment, lastUpdated, dataPoints) [Source: docs/architecture/data-models.md]
  - [x] Export all interfaces from model service package for use by backend services [Source: docs/architecture/unified-project-structure.md]

- [x] Task 3: Implement Content Generation Parameters API (AC: 2, 7, 8, 9)
  - [x] Create `generationParameters.ts` module implementing model-driven parameter calculation [Source: docs/architecture/unified-project-structure.md]
  - [x] Implement meaning-first approach algorithm (prioritizes semantic grounding over grammatical complexity) [Source: docs/brief-v2-mvp.md]
  - [x] Implement comprehensibility before correctness logic (gates by semantic access, not grammar mastery) [Source: docs/brief-v2-mvp.md]
  - [x] Implement variation pattern calculation (controlled variation around stable meaning) [Source: docs/brief-v2-mvp.md]
  - [x] Implement lexical novelty budget calculation (determines new vocabulary introduction rate) [Source: Story AC 8]
  - [x] Implement construction sets selection (grammatical patterns appropriate for difficulty level) [Source: Story AC 8]
  - [x] Implement prompt engineering guidance generation (meaning-first prompts, controlled variation specifications) [Source: Story AC 9]
  - [x] Create `getGenerationParameters()` function that accepts user preferences and returns ModelParameters [Source: Story AC 2]
  - [x] Ensure parameters align with model principles (meaning anchoring, statistical abstraction) [Source: docs/brief-v2-mvp.md]

- [x] Task 4: Implement Adaptation Decisions API (AC: 3, 7)
  - [x] Create `adaptationEngine.ts` module implementing model-informed adaptation logic [Source: docs/architecture/unified-project-structure.md]
  - [x] Implement difficulty adjustment calculation (model predictions about optimal input characteristics) [Source: docs/brief-v2-mvp.md]
  - [x] Implement content selection logic (format/genre recommendations based on learner state) [Source: Story AC 3]
  - [x] Implement lexical-heavy vs. discourse-heavy difficulty determination [Source: docs/architecture/data-models.md]
  - [x] Create `getAdaptationRecommendations()` function that accepts behavioral signals and returns AdaptationRecommendations [Source: Story AC 3]
  - [x] Ensure adaptation follows model principles (prediction under uncertainty, meaning anchoring) [Source: docs/brief-v2-mvp.md]

- [x] Task 5: Implement Signal Interpretation API (AC: 4, 7)
  - [x] Create `signalInterpreter.ts` module implementing model framework for behavioral signal interpretation [Source: docs/architecture/unified-project-structure.md]
  - [x] Implement comprehension inference from behavioral events (play, pause, skip, complete, abandon patterns) [Source: docs/architecture/data-models.md]
  - [x] Implement preference weight calculation from like engagement data [Source: docs/architecture/data-models.md]
  - [x] Implement content type preference inference (format/genre preferences from behavioral signals) [Source: Story AC 4]
  - [x] Create `interpretSignals()` function that accepts BehavioralEvents and LikeEngagement and returns SignalInterpretation [Source: Story AC 4]
  - [x] Ensure interpretation follows model principles (probabilistic competence tracking, non-linear acquisition) [Source: docs/brief-v2-mvp.md]

- [x] Task 6: Implement Learner State Representation API (AC: 5, 7)
  - [x] Create `learnerState.ts` module implementing model-based learner state tracking [Source: docs/architecture/unified-project-structure.md]
  - [x] Implement probabilistic competence map (what learner probably understands, partially understands, unstable) [Source: docs/brief-v2-mvp.md]
  - [x] Implement learner state update logic (incorporates signal interpretations into state) [Source: Story AC 5]
  - [x] Implement state persistence structure (ready for database storage in future stories) [Source: docs/architecture/data-models.md]
  - [x] Create `updateLearnerState()` function that accepts SignalInterpretation and current state, returns updated LearnerState [Source: Story AC 5]
  - [x] Create `getLearnerState()` function that returns current learner state representation [Source: Story AC 5]
  - [x] Ensure state representation follows model principles (overlapping competence estimates, non-linear progression) [Source: docs/brief-v2-mvp.md]

- [x] Task 7: Implement Model Service Main Interface and Versioning (AC: 1, 6, 11)
  - [x] Create main ModelService class implementing all API methods [Source: Story AC 1]
  - [x] Implement versioned API interface (v1 initial version, extensible for future versions) [Source: Story AC 6]
  - [x] Create factory function or class constructor for ModelService instantiation [Source: Story AC 1]
  - [x] Export ModelService from package entry point (`src/index.ts`) [Source: docs/architecture/unified-project-structure.md]
  - [x] Ensure service is designed for integration with content generation pipeline [Source: Story AC 11]
  - [x] Document API versioning strategy for future model evolution [Source: Story AC 6]

- [x] Task 8: Ensure Computational Efficiency (AC: 10)
  - [x] Review all algorithms to ensure they use heuristics/rule-based logic, not full ML implementation [Source: Story AC 10]
  - [x] Optimize parameter calculation functions for fast execution (< 100ms per request) [Source: Story AC 10]
  - [x] Ensure no external ML library dependencies (keep package lightweight) [Source: Story AC 10]
  - [x] Document computational complexity of each API method [Source: Story AC 10]

- [x] Task 9: Design for Extensibility (AC: 12)
  - [x] Structure code to support future model refinement (modular design, clear interfaces) [Source: Story AC 12]
  - [x] Document extension points for increased sophistication in Phase 2+ [Source: Story AC 12]
  - [x] Ensure versioning system supports model evolution without breaking changes [Source: Story AC 12]
  - [x] Create extension guide for future model enhancements [Source: Story AC 12]

- [x] Task 10: Create Model Service API Route (AC: 11)
  - [x] Create `/api/model/adaptation` route in backend API [Source: docs/architecture/api-specification.md]
  - [x] Integrate ModelService into backend Express application [Source: docs/architecture/unified-project-structure.md]
  - [x] Create model service route handler that calls ModelService methods [Source: Story AC 11]
  - [x] Ensure route accepts request body with sessionId, recentEvents, recentLikes, userPreferences [Source: docs/architecture/api-specification.md]
  - [x] Ensure route returns AdaptationRecommendations response [Source: docs/architecture/api-specification.md]
  - [x] Add error handling for model service API calls [Source: docs/architecture/api-specification.md]

- [x] Task 11: Unit Testing (AC: 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12)
  - [x] Create unit tests for generation parameters calculation [Source: docs/architecture/tech-stack.md]
  - [x] Create unit tests for adaptation recommendations logic [Source: docs/architecture/tech-stack.md]
  - [x] Create unit tests for signal interpretation [Source: docs/architecture/tech-stack.md]
  - [x] Create unit tests for learner state updates [Source: docs/architecture/tech-stack.md]
  - [x] Create unit tests for model service API methods [Source: docs/architecture/tech-stack.md]
  - [x] Test computational efficiency (verify < 100ms execution time) [Source: Story AC 10]
  - [x] Test versioning system [Source: Story AC 6]
  - [x] Use Vitest for testing framework [Source: docs/architecture/tech-stack.md]
  - [x] Place test files in `packages/model-service/tests/` directory [Source: docs/architecture/unified-project-structure.md]

## Dev Notes

### Previous Story Insights

**From Story 1.8 (Continuous Content Scrolling & Temporary Storage):**
- Content generation API endpoint `/api/content/generate` is ready and expects model-driven parameters
- Mock content service exists for testing without API calls
- SessionContext stores content with metadata including modelParameters field
- Content generation workflow uses polling for async generation status
- User preferences are integrated into content generation requests

**Key Integration Points:**
- Model service will be called by content generation service to get generation parameters
- Model service will receive behavioral events and like engagement data for adaptation
- Model service learner state will inform content selection and difficulty adjustment
- Model service must be computationally efficient to not block content generation pipeline

### Data Models

**ModelParameters Interface:**
- `lexicalNoveltyBudget`: number - Rate of new vocabulary introduction [Source: docs/architecture/data-models.md]
- `constructionSets`: string[] - Grammatical patterns for content generation [Source: docs/architecture/data-models.md]
- `variationPattern`: string - Pattern specification for controlled variation [Source: docs/architecture/data-models.md]
- `comprehensibilityTarget`: number - Target comprehensibility score (0-1) [Source: docs/architecture/data-models.md]
- `semanticStability`: number - Semantic stability requirement for meaning anchoring [Source: docs/architecture/data-models.md]
- `discourseComplexity`: number (optional) - Discourse complexity level (post-MVP) [Source: docs/architecture/data-models.md]
- `vocabularyLevel`: string (optional) - Vocabulary level specification (post-MVP) [Source: docs/architecture/data-models.md]
- `grammarComplexity`: number (optional) - Grammar complexity level (post-MVP) [Source: docs/architecture/data-models.md]

**LearnerModelState Interface:**
- `preferenceWeights`: PreferenceWeights - Model-inferred preference scores [Source: docs/architecture/data-models.md]
- `comprehensionLevel`: number - Inferred comprehension level (0-1 scale) [Source: docs/architecture/data-models.md]
- `contentTypePreferences`: ContentTypePreferences - Format/genre preference scores [Source: docs/architecture/data-models.md]
- `difficultyAdjustment`: number - Model-calculated difficulty adjustment [Source: docs/architecture/data-models.md]
- `lastUpdated`: Date - Last model update timestamp [Source: docs/architecture/data-models.md]
- `dataPoints`: number - Number of behavioral signals processed [Source: docs/architecture/data-models.md]

**BehavioralEvent Interface:**
- Event types: 'play', 'pause', 'resume', 'stop', 'skip-forward', 'skip-backward', 'replay-segment', 'complete', 'abandon', 'abandon-early', 'abandon-mid', 'abandon-late', 'like', 'unlike' [Source: docs/architecture/data-models.md]
- `contentId`: string - Associated content identifier [Source: docs/architecture/data-models.md]
- `eventType`: BehavioralEventType - Granular event type classification [Source: docs/architecture/data-models.md]
- `timestamp`: Date - Event timestamp [Source: docs/architecture/data-models.md]
- `playbackPosition`: number - Playback position in seconds [Source: docs/architecture/data-models.md]
- `playbackPositionPercent`: number - Playback position as percentage (0-100) [Source: docs/architecture/data-models.md]
- `sessionId`: string - Session identifier [Source: docs/architecture/data-models.md]
- `contentCharacteristics`: ContentCharacteristics - Content metadata for pattern analysis [Source: docs/architecture/data-models.md]

**LikeEngagement Interface:**
- `contentId`: string - Associated content identifier [Source: docs/architecture/data-models.md]
- `liked`: boolean - Like status [Source: docs/architecture/data-models.md]
- `likedAt`: Date | null - Like timestamp [Source: docs/architecture/data-models.md]
- `sessionId`: string - Session identifier [Source: docs/architecture/data-models.md]
- `contentCharacteristics`: ContentCharacteristics - Content metadata for pattern analysis [Source: docs/architecture/data-models.md]

**UserPreferences Interface:**
- `difficultyPreference`: 'beginner' | 'intermediate' | 'advanced' - User-selected difficulty [Source: docs/architecture/data-models.md]
- `preferredFormats`: ('narrative' | 'podcast' | 'educational')[] - Format preferences [Source: docs/architecture/data-models.md]
- `preferredGenres`: string[] - Genre preferences (for narratives) [Source: docs/architecture/data-models.md]
- `playbackSpeed`: number - Audio playback speed multiplier [Source: docs/architecture/data-models.md]
- `autoPlay`: boolean - Auto-play on content load [Source: docs/architecture/data-models.md]

### API Specifications

**Model Service API Endpoint:**
- POST `/api/model/adaptation` - Get model-driven adaptation recommendations [Source: docs/architecture/api-specification.md]
- Request body: `{ sessionId: string, recentEvents?: BehavioralEvent[], recentLikes?: LikeEngagement[], userPreferences?: UserPreferences }` [Source: docs/architecture/api-specification.md]
- Response (200): `{ recommendedFormats: string[], recommendedGenres: string[], difficultyAdjustment: number, templateRecommendations: string[] }` [Source: docs/architecture/api-specification.md]

**Content Generation Integration:**
- Content generation service will call ModelService.getGenerationParameters() before text generation [Source: Story AC 11]
- Model parameters will be passed to Gemini API prompt construction [Source: Story AC 9]
- Model parameters will be stored in Content.modelParameters field [Source: docs/architecture/data-models.md]

### File Locations

**Model Service Package:**
- Package location: `packages/model-service/` [Source: docs/architecture/unified-project-structure.md]
- Source files: `packages/model-service/src/` [Source: docs/architecture/unified-project-structure.md]
- Model implementation: `packages/model-service/src/model/` [Source: docs/architecture/unified-project-structure.md]
  - `generationParameters.ts` - Generation parameters calculation [Source: docs/architecture/unified-project-structure.md]
  - `adaptationEngine.ts` - Adaptation decision logic [Source: docs/architecture/unified-project-structure.md]
  - `signalInterpreter.ts` - Behavioral signal interpretation [Source: docs/architecture/unified-project-structure.md]
  - `learnerState.ts` - Learner state representation and updates [Source: docs/architecture/unified-project-structure.md]
- Interfaces: `packages/model-service/src/interfaces/` [Source: docs/architecture/unified-project-structure.md]
- Utils: `packages/model-service/src/utils/` [Source: docs/architecture/unified-project-structure.md]
- Entry point: `packages/model-service/src/index.ts` [Source: docs/architecture/unified-project-structure.md]
- Tests: `packages/model-service/tests/` [Source: docs/architecture/unified-project-structure.md]

**Backend API Integration:**
- Model service route: `apps/api/src/routes/model.routes.ts` [Source: docs/architecture/unified-project-structure.md]
- Model service integration: Import ModelService from `@packages/model-service` package [Source: docs/architecture/unified-project-structure.md]

### Technical Constraints

- **TypeScript Version:** Must use TypeScript 5.x [Source: docs/architecture/tech-stack.md]
- **Package Manager:** Must use pnpm (required for monorepo consistency) [Source: docs/architecture/tech-stack.md]
- **No ML Libraries:** Model service must use algorithms/heuristics, not full ML implementation [Source: Story AC 10]
- **Computational Efficiency:** All API methods must execute in < 100ms [Source: Story AC 10]
- **Monorepo Structure:** Model service is independent package in `packages/model-service/` [Source: docs/architecture/unified-project-structure.md]
- **Versioning:** API must be versioned to support model evolution (v1 initial) [Source: Story AC 6]

### Foundation Model Principles

**Core Model Principles to Implement:**
1. **Meaning-first approach:** Prioritizes semantic grounding over grammatical complexity [Source: docs/brief-v2-mvp.md]
2. **Comprehensibility before correctness:** Gates by semantic access, not grammar mastery [Source: docs/brief-v2-mvp.md]
3. **Variation is essential:** Controlled variation around stable meaning drives abstraction [Source: docs/brief-v2-mvp.md]
4. **Prediction under uncertainty:** Model operates with probabilistic predictions, not deterministic rules [Source: docs/brief-v2-mvp.md]
5. **Meaning anchoring:** Language must be coupled to something other than language (narrative context, situational intent) [Source: docs/brief-v2-mvp.md]
6. **Statistical abstraction:** Generalization requires contrast across exemplars [Source: docs/brief-v2-mvp.md]
7. **Re-expression/compression:** Output tasks force reorganization and expose uncertainty [Source: docs/brief-v2-mvp.md]

**Model Implementation Approach:**
- Model service implements these principles through algorithms and heuristics, not full ML [Source: Story AC 10]
- Model service provides parameters and recommendations, not direct content generation [Source: Story AC 2, 3]
- Model service is computationally efficient for real-time adaptation [Source: Story AC 10]
- Model service designed for extensibility and future refinement [Source: Story AC 12]

### Project Structure Notes

- Model service is independent package in monorepo structure [Source: docs/architecture/unified-project-structure.md]
- Model service exports interfaces and classes for use by backend services [Source: docs/architecture/unified-project-structure.md]
- Model service does not depend on backend or frontend packages [Source: docs/architecture/unified-project-structure.md]
- Backend services import ModelService from `@packages/model-service` package [Source: docs/architecture/unified-project-structure.md]
- Shared types may be defined in `packages/shared/src/types/` if needed across packages [Source: docs/architecture/unified-project-structure.md]

### Testing

**Testing Standards:**
- Testing framework: Vitest [Source: docs/architecture/tech-stack.md]
- Test file locations: `packages/model-service/tests/` [Source: docs/architecture/unified-project-structure.md]
- Test coverage: Unit tests for all model service API methods [Source: Story AC 1-12]
- Performance testing: Verify computational efficiency (< 100ms per request) [Source: Story AC 10]

**Testing Approach:**
- Unit tests for generation parameters calculation with various user preferences
- Unit tests for adaptation recommendations with different behavioral signal patterns
- Unit tests for signal interpretation with various event types and patterns
- Unit tests for learner state updates and state persistence
- Unit tests for model service API versioning
- Performance tests to verify computational efficiency
- Integration tests for model service API route (in backend tests)

**Test Data:**
- Create mock BehavioralEvent data for testing signal interpretation
- Create mock LikeEngagement data for testing preference inference
- Create mock UserPreferences for testing generation parameters
- Create mock LearnerState for testing state updates

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-07 | 1.0 | Initial story draft created | Scrum Master |

## Dev Agent Record

### Agent Model Used
Claude Sonnet 4.5 (via Cursor)

### Implementation Summary

**Completed:** All 11 tasks for Story 2.1 - Foundation Model Service Implementation

**Key Achievements:**
1. Created complete model service package with versioned API (v1)
2. Implemented all core model principles through heuristic-based algorithms
3. Created comprehensive test suite with 42 passing tests
4. Verified computational efficiency (< 100ms per request)
5. Integrated model service into backend API with `/api/model/adaptation` route
6. Documented extension points for future model refinement

**Model Principles Implemented:**
- Meaning-first approach (prioritizes semantic grounding)
- Comprehensibility before correctness (gates by semantic access)
- Variation is essential (controlled variation around stable meaning)
- Prediction under uncertainty (probabilistic adjustments)
- Meaning anchoring (language coupled to non-linguistic context)
- Statistical abstraction (generalization across exemplars)
- Non-linear acquisition (overlapping competence estimates)

### File List

**Model Service Package (`packages/model-service/`):**
- `src/index.ts` - Package entry point
- `src/model-service.ts` - Main ModelService class
- `src/interfaces/v1/` - Versioned API interfaces
  - `index.ts`
  - `model-service.interface.ts`
  - `generation-parameters.interface.ts`
  - `adaptation-recommendations.interface.ts`
  - `signal-interpretation.interface.ts`
  - `learner-state.interface.ts`
- `src/interfaces/types/` - Type definitions
  - `user-preferences.type.ts`
  - `behavioral-event.type.ts`
  - `like-engagement.type.ts`
- `src/model/` - Model implementation modules
  - `generationParameters.ts` - Generation parameters calculation
  - `adaptationEngine.ts` - Adaptation decision logic
  - `signalInterpreter.ts` - Behavioral signal interpretation
  - `learnerState.ts` - Learner state representation and updates
- `tests/` - Unit tests
  - `generationParameters.test.ts`
  - `adaptationEngine.test.ts`
  - `signalInterpreter.test.ts`
  - `learnerState.test.ts`
  - `modelService.test.ts`
  - `performance.test.ts`
- `vitest.config.ts` - Vitest configuration
- `EXTENSION_GUIDE.md` - Extension guide for future enhancements
- `package.json` - Package configuration (updated)
- `tsconfig.json` - TypeScript configuration

**Backend API Integration (`apps/api/`):**
- `src/routes/model.routes.ts` - Model service API route
- `src/server.ts` - Updated to include model routes
- `package.json` - Updated with model-service dependency

### Completion Notes

1. **Versioned API Structure:** Created v1 interface structure in `src/interfaces/v1/` to support future model evolution without breaking changes.

2. **Heuristic-Based Implementation:** All algorithms use rule-based heuristics and exponential moving averages, not full ML implementation, ensuring computational efficiency and no external ML dependencies.

3. **Model Principles Integration:** All modules implement foundation model principles:
   - Generation parameters prioritize meaning-first and comprehensibility
   - Adaptation engine uses prediction under uncertainty
   - Signal interpreter implements probabilistic competence tracking
   - Learner state maintains overlapping competence estimates

4. **Performance Verified:** Performance tests confirm all API methods execute in < 100ms, meeting AC 10 requirement.

5. **Comprehensive Testing:** Created 42 unit tests covering all modules, including performance tests verifying < 100ms execution time.

6. **API Integration:** Model service integrated into backend Express application with `/api/model/adaptation` route, accepting sessionId, recentEvents, recentLikes, and userPreferences.

7. **Extensibility:** Created extension guide documenting extension points for future model refinement (Bayesian inference, fine-grained construction tracking, etc.).

### Debug Log References
No blocking issues encountered during implementation.

### Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-07 | 1.0 | Initial story draft created | Scrum Master |
| 2026-01-07 | 1.1 | Story implementation completed - all tasks done | Dev Agent |
| 2026-01-07 | 1.2 | Story reviewed and validated | User |

## QA Results
_To be populated by QA Agent_
