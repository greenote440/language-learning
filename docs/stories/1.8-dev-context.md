# Story 1.8: Dev Context for Next Developer

## Current Status
**Story 1.8 is ~90% complete.** Core functionality is implemented and working. Remaining work is primarily testing and refinement.

## What's Working
- ✅ Instagram-like vertical scrolling with snap-to-item behavior
- ✅ Forward scroll triggers on-demand content generation
- ✅ Backward scroll retrieves content from session storage
- ✅ Single AudioPlayer component managed by AudioPlayerContext
- ✅ Content switching stops current playback and starts new content
- ✅ Visual indicators (scroll direction, content position, metadata)
- ✅ Content persistence via localStorage in ContentContext
- ✅ Mock content generation service (bypasses API for testing)

## Known Issues & Recent Fixes

### Scroll Getting Stuck (Just Fixed)
**Issue**: Scroll could get stuck mid-scroll, preventing snap-to-item from working.

**Fix Applied**: 
- Improved scroll end detection with better timeout handling
- Added touch end handler to force snap re-enable
- Reduced timeout from 200ms to 150ms for more responsive feel
- Added check to only snap if scroll position is >10px from target

**Location**: `MainListeningScreen.tsx` lines ~373-410

**If Issue Persists**: Consider:
- Increasing the timeout back to 200ms
- Adding a scroll momentum detection (using `requestAnimationFrame`)
- Using IntersectionObserver to detect when scroll has truly stopped

## Key Implementation Details

### Mock Mode
- **Enabled by default** via `VITE_USE_MOCK_SERVICE=true` in `.env`
- Mock service returns `undefined` for `audioUrl` (audio is optional)
- AudioPlayer displays "Modalità test: audio non disponibile" when no audio
- To enable real API: set `VITE_USE_MOCK_SERVICE=false` and ensure API is running

### Scroll Physics
- Snap is **temporarily disabled** during active scrolling for smoother feel
- Snap **re-enables** after scroll ends (150ms timeout)
- Uses CSS `scroll-snap-type: y mandatory` on container
- Each item has `scroll-snap-align: start`

### Content Persistence
- **ContentContext** persists to `localStorage` (key: `language-learning-content`)
- **SessionContext** tracks content IDs in order (in-memory only)
- Content survives page reloads
- Backward navigation uses ContentContext to retrieve full content objects

### Scroll Detection
- Uses `IntersectionObserver` to detect visible item
- Scroll direction tracked via `lastScrollTopRef` comparison
- Debounced with 300ms timeout for scroll direction indicator
- `isSwitchingRef` prevents concurrent content switches

## Architecture Notes

### Component Structure
```
MainListeningScreen
├── Scroll Container (absolute inset-0, overflow-y-scroll)
│   └── AudioPlayerItem[] (h-screen, scroll-snap-align: start)
│       └── AudioPlayer (managed by AudioPlayerContext)
└── Scroll Direction Indicator (position: fixed)
```

### State Management
- **AudioPlayerContext**: Manages single audio player instance, current content, playback state
- **ContentContext**: Stores all content objects, provides add/get methods, persists to localStorage
- **SessionContext**: Tracks content IDs in order, current content ID
- **useContentGeneration**: Hook for triggering and polling content generation

### Content Generation Flow
1. User scrolls forward → `handleScroll` detects forward direction
2. `handleContentSwitch` called with `'forward'`
3. `useContentGeneration` hook triggered
4. Mock/API service generates content
5. Content added to ContentContext and SessionContext
6. New AudioPlayerItem rendered with loading state
7. When ready, AudioPlayer autoplays new content

### Backward Navigation Flow
1. User scrolls backward → `handleScroll` detects backward direction
2. `handleContentSwitch` called with `'backward'`
3. Content retrieved from ContentContext by index
4. AudioPlayerItem already exists (or created)
5. AudioPlayer switches to previous content and autoplays

## Files Modified
- `apps/lovable_web/src/components/MainListeningScreen.tsx` - Main scrolling implementation
- `apps/lovable_web/src/components/AudioPlayer.tsx` - Made audioUrl optional
- `apps/lovable_web/src/contexts/ContentContext.tsx` - Added localStorage persistence
- `apps/lovable_web/src/contexts/AudioPlayerContext.tsx` - Made audioUrl optional in Content interface
- `apps/lovable_web/src/services/contentService.ts` - Added mock mode

## Testing Checklist (Task 9)
- [ ] Test on mobile devices (touch scrolling)
- [ ] Test on desktop (scroll wheel)
- [ ] Test rapid scrolling (should debounce/queue requests)
- [ ] Test backward navigation through entire session
- [ ] Test content persistence across page reload
- [ ] Test all three content formats (narrative, podcast, educational)
- [ ] Test autoplay behavior (may be blocked by browser policy)
- [ ] Test scroll snap behavior (should snap cleanly to items)

## Next Steps
1. **Complete Task 9**: Comprehensive testing across devices/browsers
2. **Refine scroll physics**: If stuck scrolling persists, consider momentum-based detection
3. **API Integration**: When ready, disable mock mode and test with real API
4. **Performance**: Monitor scroll performance on lower-end devices
5. **Edge Cases**: Handle rapid scroll → page reload scenarios

## Environment Variables
```bash
# Enable/disable mock content generation
VITE_USE_MOCK_SERVICE=true  # Set to false when API is ready
```

## Debugging Tips
- Check browser console for autoplay policy warnings (expected behavior)
- Use React DevTools to inspect Context state
- Check localStorage for persisted content
- Monitor network tab for API calls (when mock is disabled)
- Use browser DevTools to inspect scroll container dimensions

## Questions for Next Dev
- Is the scroll snap behavior smooth enough on your device?
- Does backward navigation feel instant?
- Are there any edge cases you've discovered during testing?
- Should we add scroll momentum detection for better physics?
